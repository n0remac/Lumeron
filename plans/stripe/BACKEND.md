## Backend Phase Plan

**Phase 1 – Stripe Service Layer**
- Install and configure the Stripe SDK in `lib/stripe.ts`, guarding against missing environment variables in dev/test.
- Implement helpers to map `Listing` data to Payment Sheet line items, calculate totals/taxes/shipping, and generate PaymentIntent metadata.
- Provide utilities for creating Stripe Customers, Customer Sessions, ephemeral keys, and verifying webhook signatures.

**Phase 2 – Payment Sheet Bootstrap API**
- Create `app/api/payments/payment-sheet` (POST) that validates cart payloads with Zod and queries Prisma for authoritative pricing.
- Persist a draft `Order` plus `OrderItem` rows in the same transaction that creates the PaymentIntent and optional CustomerSession.
- Return the PaymentIntent client secret, ephemeral key secret, customer ID, and configuration flags the frontend needs to present Payment Sheet; log diagnostics for observability.

**Phase 3 – Webhook Processing**
- Add `app/api/webhooks/stripe/route.ts` to process `payment_intent.succeeded`, `payment_intent.payment_failed`, and `payment_intent.canceled` events generated by Payment Sheet.
- Update order/payment records atomically, storing Stripe IDs, customer details, and totals; guard with idempotency checks keyed by PaymentIntent.
- On success, create `Sale` entries for site sales and mark the order ready for fulfillment; on failure, note the cancellation reason.

**Phase 4 – Fulfillment Automation**
- Hook successful payments into the existing Printify integration to create production orders or enqueue jobs for later processing.
- Track fulfillment status updates on the order record and surface relevant errors for manual intervention.
- Add logging/alerting hooks so failed webhooks or fulfillment attempts are visible to operators.

**Phase 5 – Admin & Analytics APIs**
- Extend admin API routes to query new order/payment data, including filtering by status and date range.
- Feed order totals into existing analytics helpers so revenue dashboards incorporate Stripe transactions.
- Expose Stripe dashboard links or refund actions where appropriate, keeping sensitive operations server-side only.
